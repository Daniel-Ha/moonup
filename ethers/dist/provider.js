"use strict";var d=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var R=(s,r)=>{for(var t in r)d(s,t,{get:r[t],enumerable:!0})},A=(s,r,t,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of b(r))!M.call(s,n)&&n!==t&&d(s,n,{get:()=>r[n],enumerable:!(e=k(r,n))||e.enumerable});return s};var I=s=>A(d({},"__esModule",{value:!0}),s);var B={};R(B,{MoonProvider:()=>u});module.exports=I(B);var v=require("@ethersproject/abstract-provider"),w=require("events");var h=require("@moonup/moon-types"),m=require("ethers");var T=require("@ethersproject/abstract-signer"),l=require("@ethersproject/bytes"),f=require("@ethersproject/hash"),p=require("@ethersproject/properties"),a=require("ethers"),o=class s extends T.Signer{constructor(r,t){super(),(0,p.defineReadOnly)(this,"_isSigner",!0),(0,p.defineReadOnly)(this,"provider",t),this.MoonSignerConfig=r,this.SDK=r.SDK}_signTypedData(r,t,e){throw new Error("Method not implemented.")}updateConfig(r){this.SDK=r.SDK,this.MoonSignerConfig=r}connect(r){return new s(this.MoonSignerConfig,r)}async signTypedData(r,t,e){return(await this.SDK.getAccountsSDK().signTypedData(this.MoonSignerConfig.address,{data:JSON.stringify({domain:r,types:t,value:e})}).then(i=>{if(!i.ok)throw new Error(i.statusText);return i.data.data})).signed_message||""}async getAddress(){return this.MoonSignerConfig.address}async signMessage(r){let t=new Uint8Array((0,l.arrayify)((0,f.hashMessage)(r)));return(await this.SDK.getAccountsSDK().signMessage(this.MoonSignerConfig.address,{data:t.toString(),encoding:"utf-8"}).then(n=>{if(!n.ok)throw new Error(n.statusText);return n.data.data})).signed_message||""}async broadcastTransaction(r){let t=await this.SDK.getAccountsSDK().broadcastTx(this.MoonSignerConfig.address,{rawTransaction:r,chainId:this.MoonSignerConfig.chainId});if(!t.ok)throw new Error(t.statusText);return t.data.data.transaction_hash||""}async sendTransaction(r){let t=await this.populateTransaction(r);console.log("Moon::sendTransaction: populateTransaction",t);let e=await this.signTransaction(t);console.log("Moon::sendTransaction: signedRawTx",e);let n=await this.broadcastTransaction(e||"");console.log("Moon::sendTransaction: broadcastTx res",n);let i=await this.provider?.getTransaction(n||"");return console.log("Moon::sendTransaction: txResponse",i),i||{}}transactionRequestToInputBody(r){return{chain_id:a.BigNumber.from(r.chainId).toString(),data:r.data&&r.data?.toString()||"",to:r.to,gasPrice:a.BigNumber.from(r.gasPrice).toString(),gas:a.BigNumber.from(r.gasLimit).toString(),nonce:a.BigNumber.from(r.nonce).toString(),value:r.value!==void 0?a.BigNumber.from(r.value).toString():void 0,encoding:"utf-8"}}moonTransactionResponseToTransactions(r){return r.transactions||[]}async signTransaction(r){return await this.SDK.getAccountsSDK().signTransaction(this.MoonSignerConfig.address,this.transactionRequestToInputBody(r)).then(e=>{if(!e.ok)throw new Error(e.statusText);return this.moonTransactionResponseToTransactions(e.data.data)?.at(0)?.raw_transaction})||""}async getTypedDataDomain(r,t,e,n){return{name:r,version:t,chainId:e,verifyingContract:n}}async getTypedData(r,t,e){return{domain:r,types:t,message:e}}};var y=require("@ethersproject/bytes"),D=require("@ethersproject/hash"),g=require("ethers"),P=s=>{let r=s.filter(e=>!g.utils.isAddress(e))[0];return new Uint8Array((0,y.arrayify)((0,D.hashMessage)(r)))},S=s=>{let r=s.filter(t=>!g.utils.isAddress(t))[0];return typeof r=="string"?JSON.parse(r):r};var c=class{constructor(r){this.config=r,this.chainId=r.chainId;let t=(0,h.getRpcUrls)(this.chainId).pop()||"";this.sdk=r.SDK,this.http=new m.providers.JsonRpcProvider(t),this.signer=new o({SDK:this.sdk,address:r.address,chainId:this.chainId.toString()})}async request(r){switch(r.method){case"eth_requestAccounts":return(await this.sdk.listAccounts()).keys||[];case"personal_sign":if(Array.isArray(r.params)&&r.params.length>0){let n=P(r?.params);return await this.signer.signMessage(n)}else throw new Error("request.params is undefined or not an array");case"eth_signTypedData":if(Array.isArray(r.params)&&r.params.length>0){let n=S(r?.params);return await this.signer.signTypedData(n.domain,n.types,n.value)||""}else throw new Error("request.params is undefined or not an array");case"eth_sendTransaction":let e=r?.params&&Array.isArray(r?.params)&&r?.params[0]?r?.params[0]:void 0;if(e)return await this.signer.sendTransaction(e);throw new Error("eth_sendTransaction error");default:return await this.http.send(r.method,r.params||[])}}updateConfig(r){this.chainId=r.chainId,this.sdk=r.SDK,this.http=new m.providers.JsonRpcProvider((0,h.getRpcUrls)(this.chainId).pop()||""),this.signer.updateConfig({SDK:this.sdk,address:"",chainId:this.chainId.toString()})}};var u=class extends v.Provider{constructor(t){super();this.events=new w.EventEmitter;this.address="";this.chainId=t.chainId,this.sdk=t.SDK,this.address=t.address,this.rpc=new c(t)}async request(t){switch(t.method){case"eth_requestAccounts":return await this.sdk.listAccounts();case"eth_accounts":return this.rpc.signer.getAddress();case"eth_chainId":return this.chainId;case"wallet_switchEthereumChain":let e=t?.params&&Array.isArray(t?.params)&&t?.params[0]?t?.params[0]:void 0,n=typeof e?.chainId=="string"&&e?.chainId?.startsWith("0x")?parseInt(e?.chainId,16):e?.chainId;this.updateConfig({chainId:n,SDK:this.sdk,address:this.address}),this.chainId=n,this.events.emit("chainChanged",e?.chainId);return;case"accountsChanged":let i=t?.params&&Array.isArray(t?.params)&&t?.params[0]?t?.params[0]:void 0;this.address=i[0],this.updateConfig({chainId:this.chainId,SDK:this.sdk,address:i[0]}),this.events.emit("accountsChanged",i);return;default:break}return await this.rpc.request(t)}updateConfig(t){this.chainId=t.chainId,this.sdk=t.SDK,this.rpc.updateConfig(t)}async connect(){this.events.emit("connect")}async disconnect(){this.events.emit("disconnect")}sendAsync(t,e){this.request(t).then(n=>e(null,n)).catch(n=>e(n,void 0))}async enable(){return[(await this.request({method:"eth_requestAccounts"}))?.address||""]}isMoonProvider(){return!0}getChainId(){return this.chainId}getSigner(){return this.rpc.signer}getNetwork(){return this.rpc.http.getNetwork()}getBlockNumber(){return this.rpc.http.getBlockNumber()}getGasPrice(){return this.rpc.http.getGasPrice()}getBalance(t,e){return this.rpc.http.getBalance(t,e)}getTransactionCount(t,e){return this.rpc.http.getTransactionCount(t,e)}getCode(t,e){return this.rpc.http.getCode(t,e)}getStorageAt(t,e,n){return this.rpc.http.getStorageAt(t,e,n)}sendTransaction(t){return this.rpc.http.sendTransaction(t)}call(t,e){return this.rpc.http.call(t,e)}estimateGas(t){return this.rpc.http.estimateGas(t)}getBlock(t){return this.rpc.http.getBlock(t)}getBlockWithTransactions(t){return this.rpc.http.getBlockWithTransactions(t)}getTransaction(t){return this.rpc.http.getTransaction(t)}getTransactionReceipt(t){return this.rpc.http.getTransactionReceipt(t)}getLogs(t){return this.rpc.http.getLogs(t)}resolveName(t){return this.rpc.http.resolveName(t)}lookupAddress(t){return this.rpc.http.lookupAddress(t)}emit(t,...e){return this.rpc.http.emit(t,...e)}listenerCount(t){return this.rpc.http.listenerCount(t)}listeners(t){return this.rpc.http.listeners(t)}removeAllListeners(t){return this.rpc.http.removeAllListeners(t)}waitForTransaction(t,e,n){return this.rpc.http.waitForTransaction(t,e,n)}on(t,e){return this.rpc.http.on(t,e)}once(t,e){return this.rpc.http.once(t,e)}off(t,e){return this.rpc.http.off(t,e)}};0&&(module.exports={MoonProvider});
//# sourceMappingURL=provider.js.map