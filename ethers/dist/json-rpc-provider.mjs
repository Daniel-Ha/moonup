import{getRpcUrls as m}from"@moonup/moon-types";import{providers as h}from"ethers";import{Signer as y}from"@ethersproject/abstract-signer";import{arrayify as u}from"@ethersproject/bytes";import{hashMessage as f}from"@ethersproject/hash";import{defineReadOnly as d}from"@ethersproject/properties";import{BigNumber as i}from"ethers";var e=class o extends y{constructor(n,a){super(),d(this,"_isSigner",!0),d(this,"provider",a),this.MoonSignerConfig=n,this.SDK=n.SDK}_signTypedData(n,a,s){throw new Error("Method not implemented.")}updateConfig(n){this.SDK=n.SDK,this.MoonSignerConfig=n}connect(n){return new o(this.MoonSignerConfig,n)}async signTypedData(n,a,s){return(await this.SDK.getAccountsSDK().signTypedData(this.MoonSignerConfig.address,{data:JSON.stringify({domain:n,types:a,value:s})}).then(r=>{if(!r.ok)throw new Error(r.statusText);return r.data.data})).signed_message||""}async getAddress(){return this.MoonSignerConfig.address}async signMessage(n){let a=new Uint8Array(u(f(n)));return(await this.SDK.getAccountsSDK().signMessage(this.MoonSignerConfig.address,{data:a.toString(),encoding:"utf-8"}).then(t=>{if(!t.ok)throw new Error(t.statusText);return t.data.data})).signed_message||""}async broadcastTransaction(n){let a=await this.SDK.getAccountsSDK().broadcastTx(this.MoonSignerConfig.address,{rawTransaction:n,chainId:this.MoonSignerConfig.chainId});if(!a.ok)throw new Error(a.statusText);return a.data.data.transaction_hash||""}async sendTransaction(n){let a=await this.populateTransaction(n);console.log("Moon::sendTransaction: populateTransaction",a);let s=await this.signTransaction(a);console.log("Moon::sendTransaction: signedRawTx",s);let t=await this.broadcastTransaction(s||"");console.log("Moon::sendTransaction: broadcastTx res",t);let r=await this.provider?.getTransaction(t||"");return console.log("Moon::sendTransaction: txResponse",r),r||{}}transactionRequestToInputBody(n){return{chain_id:i.from(n.chainId).toString(),data:n.data&&n.data?.toString()||"",to:n.to,gasPrice:i.from(n.gasPrice).toString(),gas:i.from(n.gasLimit).toString(),nonce:i.from(n.nonce).toString(),value:n.value!==void 0?i.from(n.value).toString():void 0,encoding:"utf-8"}}moonTransactionResponseToTransactions(n){return n.transactions||[]}async signTransaction(n){return await this.SDK.getAccountsSDK().signTransaction(this.MoonSignerConfig.address,this.transactionRequestToInputBody(n)).then(s=>{if(!s.ok)throw new Error(s.statusText);return this.moonTransactionResponseToTransactions(s.data.data)?.at(0)?.raw_transaction})||""}async getTypedDataDomain(n,a,s,t){return{name:n,version:a,chainId:s,verifyingContract:t}}async getTypedData(n,a,s){return{domain:n,types:a,message:s}}};import{arrayify as D}from"@ethersproject/bytes";import{hashMessage as S}from"@ethersproject/hash";import{utils as c}from"ethers";var g=o=>{let n=o.filter(s=>!c.isAddress(s))[0];return new Uint8Array(D(S(n)))},p=o=>{let n=o.filter(a=>!c.isAddress(a))[0];return typeof n=="string"?JSON.parse(n):n};var T=class{constructor(n){this.config=n,this.chainId=n.chainId;let a=m(this.chainId).pop()||"";this.sdk=n.SDK,this.http=new h.JsonRpcProvider(a),this.signer=new e({SDK:this.sdk,address:n.address,chainId:this.chainId.toString()})}async request(n){switch(n.method){case"eth_requestAccounts":return(await this.sdk.listAccounts()).keys||[];case"personal_sign":if(Array.isArray(n.params)&&n.params.length>0){let t=g(n?.params);return await this.signer.signMessage(t)}else throw new Error("request.params is undefined or not an array");case"eth_signTypedData":if(Array.isArray(n.params)&&n.params.length>0){let t=p(n?.params);return await this.signer.signTypedData(t.domain,t.types,t.value)||""}else throw new Error("request.params is undefined or not an array");case"eth_sendTransaction":let s=n?.params&&Array.isArray(n?.params)&&n?.params[0]?n?.params[0]:void 0;if(s)return await this.signer.sendTransaction(s);throw new Error("eth_sendTransaction error");default:return await this.http.send(n.method,n.params||[])}}updateConfig(n){this.chainId=n.chainId,this.sdk=n.SDK,this.http=new h.JsonRpcProvider(m(this.chainId).pop()||""),this.signer.updateConfig({SDK:this.sdk,address:"",chainId:this.chainId.toString()})}};export{T as JsonRpcProvider};
//# sourceMappingURL=json-rpc-provider.mjs.map